<div id="giscus-container"></div>

<script>
  (function () {
    const THEME_KEY = "giscus-theme-preference";
    const GISCUS_ORIGIN = "https://giscus.app";
    const THEME_URLS = {
      dark: "https://leafevans.github.io/css/giscus-fire-dark.css",
      light: "https://leafevans.github.io/css/giscus-fire-light.css",
    };

    function withCurrentTheme(callback) {
      const isDark = document.documentElement.classList.contains("dark");
      const theme = isDark ? "dark" : "light";
      return callback(theme, THEME_URLS[theme]);
    }

    function updateGiscusTheme(frame) {
      withCurrentTheme((_, themeUrl) => {
        try {
          if (!frame) {
            frame = document.querySelector("iframe.giscus-frame");
            if (!frame) return;
          }

          frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme: themeUrl } } },
            GISCUS_ORIGIN
          );
        } catch (e) {
          console.debug("Failed to update Giscus theme:", e);
        }
      });
    }

    function saveThemePreference(updateGiscus = false) {
      withCurrentTheme((theme) => {
        try {
          const stored = localStorage.getItem(THEME_KEY);
          if (stored !== theme) {
            localStorage.setItem(THEME_KEY, theme);
            if (updateGiscus) updateGiscusTheme();
          }
        } catch (e) {
          console.debug("Failed to save theme preference:", e);
        }
      });
    }

    function loadGiscus() {
      saveThemePreference();

      const container = document.getElementById("giscus-container");
      container.innerHTML = "";

      const script = document.createElement("script");
      script.src = `${GISCUS_ORIGIN}/client.js`;

      const attrs = {
        "data-repo": "LeafEvans/leafevans.github.io",
        "data-repo-id": "R_kgDOP5oBLw",
        "data-category": "Comments",
        "data-category-id": "DIC_kwDOP5oBL84CwFBN",
        "data-mapping": "pathname",
        "data-strict": "0",
        "data-reactions-enabled": "1",
        "data-emit-metadata": "0",
        "data-input-position": "bottom",
        "data-lang": "zh-CN",
        crossorigin: "anonymous",
      };

      Object.entries(attrs).forEach(([key, value]) => {
        script.setAttribute(key, value);
      });

      withCurrentTheme((_, themeUrl) => {
        script.setAttribute("data-theme", themeUrl);
      });

      script.async = true;
      container.appendChild(script);
    }

    function initializeEventListeners() {
      new MutationObserver(() => saveThemePreference(true)).observe(
        document.documentElement,
        {
          attributes: true,
          attributeFilter: ["class"],
        }
      );

      window.addEventListener("message", (event) => {
        if (event.origin !== GISCUS_ORIGIN) return;

        try {
          const data = event.data;
          if (
            data?.giscus &&
            (data.giscus.discussion ||
              data.giscus.error ||
              data.giscus.authenticated !== undefined)
          ) {
            setTimeout(updateGiscusTheme, 300);
          }
        } catch (e) {
          console.debug("Failed to process Giscus message:", e);
        }
      });

      new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          mutation.addedNodes.forEach((node) => {
            if (
              node.nodeName === "IFRAME" &&
              node.classList.contains("giscus-frame")
            ) {
              node.addEventListener("load", () =>
                setTimeout(() => updateGiscusTheme(node), 200)
              );
              setTimeout(() => updateGiscusTheme(node), 100);
            }
          });
        });
      }).observe(document, {
        childList: true,
        subtree: true,
      });

      document.addEventListener(
        "click",
        (e) => {
          if (
            e.target &&
            (e.target.innerText || "").match(/login|sign|退出|登录/i)
          ) {
            setTimeout(updateGiscusTheme, 1000);
          }
        },
        true
      );

      setInterval(saveThemePreference, 5000);
    }

    window.addEventListener("load", () => {
      loadGiscus();
      initializeEventListeners();
    });
  })();
</script>
