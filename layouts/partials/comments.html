<div id="giscus-container"></div>

<script>
  (function () {
    "use strict";

    const CONFIG = {
      GISCUS_ORIGIN: "https://giscus.app",
      THEME_URLS: {
        dark: "https://leafevans.github.io/css/giscus-fire-dark.css",
        light: "https://leafevans.github.io/css/giscus-fire-light.css",
      },
      GISCUS_ATTRS: {
        "data-repo": "LeafEvans/leafevans.github.io",
        "data-repo-id": "R_kgDOP5oBLw",
        "data-category": "Comments",
        "data-category-id": "DIC_kwDOP5oBL84CwFBN",
        "data-mapping": "pathname",
        "data-strict": "0",
        "data-reactions-enabled": "1",
        "data-emit-metadata": "0",
        "data-input-position": "bottom",
        "data-lang": "zh-CN",
        crossorigin: "anonymous",
      },
    };

    const GiscusController = {
      getThemeUrl() {
        const isDark = document.documentElement.classList.contains("dark");
        return CONFIG.THEME_URLS[isDark ? "dark" : "light"];
      },

      updateTheme() {
        const iframe = document.querySelector("iframe.giscus-frame");
        if (!iframe?.contentWindow) return;

        const message = {
          giscus: { setConfig: { theme: this.getThemeUrl() } },
        };
        iframe.contentWindow.postMessage(message, CONFIG.GISCUS_ORIGIN);
      },

      init() {
        this.loadScript();
        this.setupEventListeners();
      },

      loadScript() {
        const container = document.getElementById("giscus-container");
        if (!container) return;

        const script = document.createElement("script");
        script.src = `${CONFIG.GISCUS_ORIGIN}/client.js`;
        script.async = true;
        script.setAttribute("data-theme", this.getThemeUrl());

        Object.entries(CONFIG.GISCUS_ATTRS).forEach(([key, value]) => {
          script.setAttribute(key, value);
        });

        container.appendChild(script);
      },

      setupEventListeners() {
        new MutationObserver(() => this.updateTheme()).observe(
          document.documentElement,
          { attributes: true, attributeFilter: ["class"] }
        );

        window.addEventListener("message", (event) => {
          if (event.origin === CONFIG.GISCUS_ORIGIN && event.data?.giscus) {
            this.updateTheme();
          }
        });
      },
    };

    GiscusController.init();
  })();
</script>
