<div id="giscus-container"></div>

<script>
  (function () {
    "use strict";

    const CONFIG = {
      THEME_KEY: "giscus-theme-preference",
      GISCUS_ORIGIN: "https://giscus.app",
      THEME_URLS: {
        dark: "https://leafevans.github.io/css/giscus-fire-dark.css",
        light: "https://leafevans.github.io/css/giscus-fire-light.css",
      },
      GISCUS_ATTRS: {
        "data-repo": "LeafEvans/leafevans.github.io",
        "data-repo-id": "R_kgDOP5oBLw",
        "data-category": "Comments",
        "data-category-id": "DIC_kwDOP5oBL84CwFBN",
        "data-mapping": "pathname",
        "data-strict": "0",
        "data-reactions-enabled": "1",
        "data-emit-metadata": "0",
        "data-input-position": "bottom",
        "data-lang": "zh-CN",
        crossorigin: "anonymous",
      },
      DELAYS: {
        MESSAGE_RESPONSE: [50, 200],
        IFRAME_LOAD: [0, 100, 300],
        AUTH_ACTION: [0, 100, 300, 600],
        SYNC_INTERVAL: 2000,
      },
    };

    const getCurrentTheme = () => {
      const isDark = document.documentElement.classList.contains("dark");
      return {
        name: isDark ? "dark" : "light",
        url: CONFIG.THEME_URLS[isDark ? "dark" : "light"],
      };
    };

    const safeLocalStorage = {
      get: (key) => {
        try {
          return localStorage.getItem(key);
        } catch (e) {
          console.debug("Failed to read localStorage:", e);
          return null;
        }
      },
      set: (key, value) => {
        try {
          localStorage.setItem(key, value);
          return true;
        } catch (e) {
          console.debug("Failed to write localStorage:", e);
          return false;
        }
      },
    };

    const getGiscusFrame = () => document.querySelector("iframe.giscus-frame");

    let lastThemeState = null;

    const updateGiscusTheme = (frame = null) => {
      const { name, url } = getCurrentTheme();
      lastThemeState = name;
      try {
        const targetFrame = frame || getGiscusFrame();
        if (!targetFrame) return;
        targetFrame.dataset.expectedTheme = name;
        targetFrame.contentWindow.postMessage(
          { giscus: { setConfig: { theme: url } } },
          CONFIG.GISCUS_ORIGIN
        );
        safeLocalStorage.set(CONFIG.THEME_KEY, name);
      } catch (e) {
        console.debug("Failed to update Giscus theme:", e);
      }
    };

    const saveThemePreference = (shouldUpdateGiscus = false) => {
      const { name } = getCurrentTheme();
      const stored = safeLocalStorage.get(CONFIG.THEME_KEY);
      if (stored !== name) {
        safeLocalStorage.set(CONFIG.THEME_KEY, name);
        if (shouldUpdateGiscus) {
          updateGiscusTheme();
        }
      }
    };

    const loadGiscus = () => {
      saveThemePreference();
      const container = document.getElementById("giscus-container");
      if (!container) return;
      container.innerHTML = "";
      const script = document.createElement("script");
      script.src = `${CONFIG.GISCUS_ORIGIN}/client.js`;
      script.async = true;
      Object.entries(CONFIG.GISCUS_ATTRS).forEach(([key, value]) => {
        script.setAttribute(key, value);
      });
      const { url } = getCurrentTheme();
      script.setAttribute("data-theme", url);
      container.appendChild(script);
    };

    const scheduleUpdates = (delays, frame = null) => {
      delays.forEach((delay) => {
        setTimeout(() => updateGiscusTheme(frame), delay);
      });
    };

    const setupThemeObserver = () => {
      new MutationObserver(() => {
        updateGiscusTheme();
        saveThemePreference();
      }).observe(document.documentElement, {
        attributes: true,
        attributeFilter: ["class"],
      });
    };

    const setupMessageListener = () => {
      window.addEventListener("message", (event) => {
        if (event.origin !== CONFIG.GISCUS_ORIGIN) return;
        try {
          const data = event.data?.giscus;
          if (!data) return;
          if (data.authenticated === false) {
            updateGiscusTheme();
            scheduleUpdates(CONFIG.DELAYS.AUTH_ACTION);
            return;
          }
          const shouldUpdate =
            data.discussion ||
            data.error ||
            data.authenticated !== undefined ||
            data.viewer !== undefined;
          if (shouldUpdate) {
            updateGiscusTheme();
            scheduleUpdates(CONFIG.DELAYS.MESSAGE_RESPONSE);
          }
        } catch (e) {
          console.debug("Failed to process Giscus message:", e);
        }
      });
    };

    const setupIframeObserver = () => {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (
            entry.isIntersecting &&
            entry.target.classList?.contains("giscus-frame")
          ) {
            updateGiscusTheme(entry.target);
          }
        });
      });

      new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          mutation.addedNodes.forEach((node) => {
            if (
              node.nodeName === "IFRAME" &&
              node.classList?.contains("giscus-frame")
            ) {
              updateGiscusTheme(node);
              observer.observe(node);
              node.addEventListener("load", () => {
                updateGiscusTheme(node);
                scheduleUpdates(CONFIG.DELAYS.IFRAME_LOAD.slice(1), node);
              });
            }
          });
        });
      }).observe(document, {
        childList: true,
        subtree: true,
      });
    };

    const setupAuthListener = () => {
      const authPattern = /login|sign|退出|登录|log out|sign out/i;
      document.addEventListener(
        "click",
        (e) => {
          const text = e.target?.innerText || e.target?.textContent || "";
          if (authPattern.test(text)) {
            updateGiscusTheme();
            scheduleUpdates(CONFIG.DELAYS.AUTH_ACTION);
          }
        },
        true
      );
    };

    const setupPeriodicSync = () => {
      setInterval(() => {
        const { name } = getCurrentTheme();
        if (lastThemeState !== name) {
          updateGiscusTheme();
        } else {
          const frame = getGiscusFrame();
          if (frame && frame.dataset.expectedTheme !== name) {
            updateGiscusTheme(frame);
          }
        }
      }, CONFIG.DELAYS.SYNC_INTERVAL);
    };

    const initializeEventListeners = () => {
      setupThemeObserver();
      setupMessageListener();
      setupIframeObserver();
      setupAuthListener();
      setupPeriodicSync();
    };

    const initialize = () => {
      const style = document.createElement("style");
      style.textContent = `
        iframe.giscus-frame {
          transition: background-color 0.2s ease;
        }
      `;
      document.head.appendChild(style);
      lastThemeState = getCurrentTheme().name;
      loadGiscus();
      initializeEventListeners();
    };

    if (document.readyState === "loading") {
      window.addEventListener("load", initialize);
    } else {
      initialize();
    }
  })();
</script>
