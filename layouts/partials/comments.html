<div id="giscus-container"></div>

<script>
  (function () {
    "use strict";

    const CONFIG = {
      GISCUS_ORIGIN: "https://giscus.app",
      THEME_URLS: {
        dark: "https://leafevans.github.io/css/giscus-fire-dark.css",
        light: "https://leafevans.github.io/css/giscus-fire-light.css",
      },
      GISCUS_ATTRS: {
        "data-repo": "LeafEvans/leafevans.github.io",
        "data-repo-id": "R_kgDOP5oBLw",
        "data-category": "Comments",
        "data-category-id": "DIC_kwDOP5oBL84CwFBN",
        "data-mapping": "pathname",
        "data-strict": "0",
        "data-reactions-enabled": "1",
        "data-emit-metadata": "0",
        "data-input-position": "bottom",
        "data-lang": "zh-CN",
        crossorigin: "anonymous",
      },
    };

    const getCurrentTheme = () => {
      const isDark = document.documentElement.classList.contains("dark");
      return {
        name: isDark ? "dark" : "light",
        url: CONFIG.THEME_URLS[isDark ? "dark" : "light"],
      };
    };

    const updateGiscusTheme = () => {
      const iframe = document.querySelector("iframe.giscus-frame");
      if (!iframe || !iframe.contentWindow) {
        return;
      }
      const theme = getCurrentTheme();
      iframe.contentWindow.postMessage(
        { giscus: { setConfig: { theme: theme.url } } },
        CONFIG.GISCUS_ORIGIN
      );
    };

    const loadGiscus = () => {
      const container = document.getElementById("giscus-container");
      if (!container) return;

      const theme = getCurrentTheme();
      const script = document.createElement("script");
      script.src = `${CONFIG.GISCUS_ORIGIN}/client.js`;
      script.async = true;

      Object.entries(CONFIG.GISCUS_ATTRS).forEach(([key, value]) => {
        script.setAttribute(key, value);
      });
      script.setAttribute("data-theme", theme.url);

      container.appendChild(script);
    };

    const initializeEventListeners = () => {
      new MutationObserver(updateGiscusTheme).observe(
        document.documentElement,
        {
          attributes: true,
          attributeFilter: ["class"],
        }
      );

      window.addEventListener("message", (event) => {
        if (event.origin !== CONFIG.GISCUS_ORIGIN) return;
        if (event.data?.giscus) {
          setTimeout(updateGiscusTheme, 100);
        }
      });

      new MutationObserver((mutations, observer) => {
        for (const mutation of mutations) {
          for (const node of mutation.addedNodes) {
            if (
              node.nodeName === "IFRAME" &&
              node.classList.contains("giscus-frame")
            ) {
              node.addEventListener("load", updateGiscusTheme, { once: true });
              observer.disconnect();
            }
          }
        }
      }).observe(document.body, {
        childList: true,
        subtree: true,
      });
    };

    loadGiscus();
    initializeEventListeners();
  })();
</script>
