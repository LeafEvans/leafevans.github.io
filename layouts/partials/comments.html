<div id="giscus-container"></div>

<script>
  (function () {
    "use strict";

    const CONFIG = {
      THEME_KEY: "giscus-theme-preference",
      GISCUS_ORIGIN: "https://giscus.app",
      THEME_URLS: {
        dark: "https://leafevans.github.io/css/giscus-fire-dark.css",
        light: "https://leafevans.github.io/css/giscus-fire-light.css",
      },
      GISCUS_ATTRS: {
        "data-repo": "LeafEvans/leafevans.github.io",
        "data-repo-id": "R_kgDOP5oBLw",
        "data-category": "Comments",
        "data-category-id": "DIC_kwDOP5oBL84CwFBN",
        "data-mapping": "pathname",
        "data-strict": "0",
        "data-reactions-enabled": "1",
        "data-emit-metadata": "0",
        "data-input-position": "bottom",
        "data-lang": "zh-CN",
        crossorigin: "anonymous",
      },
    };

    const getCurrentTheme = () => {
      const isDark = document.documentElement.classList.contains("dark");
      return {
        name: isDark ? "dark" : "light",
        url: CONFIG.THEME_URLS[isDark ? "dark" : "light"],
      };
    };

    const safeLocalStorage = {
      get: (key) => {
        try {
          return localStorage.getItem(key);
        } catch (e) {
          console.debug("Failed to read localStorage:", e);
          return null;
        }
      },
      set: (key, value) => {
        try {
          localStorage.setItem(key, value);
          return true;
        } catch (e) {
          console.debug("Failed to write localStorage:", e);
          return false;
        }
      },
    };

    const getGiscusFrame = () => document.querySelector("iframe.giscus-frame");

    const updateGiscusTheme = (frame = null) => {
      const { name, url } = getCurrentTheme();

      try {
        const targetFrame = frame || getGiscusFrame();
        if (!targetFrame) return false;
        if (!targetFrame.contentWindow) return false;

        targetFrame.contentWindow.postMessage(
          { giscus: { setConfig: { theme: url } } },
          CONFIG.GISCUS_ORIGIN
        );

        safeLocalStorage.set(CONFIG.THEME_KEY, name);
        console.debug(`Giscus theme updated to: ${name}`);
        return true;
      } catch (e) {
        console.debug("Failed to update Giscus theme:", e);
        return false;
      }
    };

    const updateWithRetry = (frame = null, maxRetries = 5) => {
      let retryCount = 0;

      const attemptUpdate = () => {
        const success = updateGiscusTheme(frame);

        if (!success && retryCount < maxRetries) {
          retryCount++;
          console.debug(`Retry ${retryCount}/${maxRetries}`);
          setTimeout(attemptUpdate, 200 * retryCount);
        }
      };

      attemptUpdate();
    };

    const loadGiscus = () => {
      const container = document.getElementById("giscus-container");
      if (!container) return;

      container.innerHTML = "";

      const script = document.createElement("script");
      script.src = `${CONFIG.GISCUS_ORIGIN}/client.js`;
      script.async = true;

      Object.entries(CONFIG.GISCUS_ATTRS).forEach(([key, value]) => {
        script.setAttribute(key, value);
      });

      const { url } = getCurrentTheme();
      script.setAttribute("data-theme", url);
      safeLocalStorage.set(CONFIG.THEME_KEY, getCurrentTheme().name);

      container.appendChild(script);
    };

    const setupThemeObserver = () => {
      new MutationObserver(() => {
        const { name } = getCurrentTheme();
        safeLocalStorage.set(CONFIG.THEME_KEY, name);
        setTimeout(() => updateWithRetry(), 100);
      }).observe(document.documentElement, {
        attributes: true,
        attributeFilter: ["class"],
      });
    };

    const setupMessageListener = () => {
      window.addEventListener("message", (event) => {
        if (event.origin !== CONFIG.GISCUS_ORIGIN) return;

        try {
          const data = event.data?.giscus;
          if (!data) return;

          console.debug("Giscus message:", data);

          if (
            data.discussion ||
            data.error ||
            data.authenticated !== undefined ||
            data.viewer !== undefined
          ) {
            setTimeout(() => updateWithRetry(), 300);
          }
        } catch (e) {
          console.debug("Failed to process Giscus message:", e);
        }
      });
    };

    const setupIframeObserver = () => {
      const iframeLoadHandler = (iframe) => {
        updateWithRetry(iframe);
        setTimeout(() => updateWithRetry(iframe), 500);
        setTimeout(() => updateWithRetry(iframe), 1000);
      };

      new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          mutation.addedNodes.forEach((node) => {
            if (
              node.nodeName === "IFRAME" &&
              node.classList?.contains("giscus-frame")
            ) {
              console.debug("Giscus iframe detected");
              updateWithRetry(node);
              node.addEventListener("load", () => {
                console.debug("Giscus iframe loaded");
                iframeLoadHandler(node);
              });
              if (node.contentWindow) {
                iframeLoadHandler(node);
              }
            }
          });
        });
      }).observe(document, {
        childList: true,
        subtree: true,
      });
    };

    const setupAuthListener = () => {
      const authPattern = /login|sign|退出|登录|log out|sign out/i;

      document.addEventListener(
        "click",
        (e) => {
          const text = e.target?.innerText || e.target?.textContent || "";
          if (authPattern.test(text)) {
            console.debug("Auth action detected");
            setTimeout(() => updateWithRetry(), 500);
            setTimeout(() => updateWithRetry(), 1500);
            setTimeout(() => updateWithRetry(), 3000);
          }
        },
        true
      );
    };

    const setupPeriodicSync = () => {
      setInterval(() => {
        const frame = getGiscusFrame();
        if (frame) {
          const currentTheme = getCurrentTheme().name;
          const storedTheme = safeLocalStorage.get(CONFIG.THEME_KEY);

          if (currentTheme !== storedTheme) {
            console.debug("Theme mismatch detected, updating...");
            updateWithRetry(frame);
          }
        }
      }, 3000);
    };

    const initializeEventListeners = () => {
      setupThemeObserver();
      setupMessageListener();
      setupIframeObserver();
      setupAuthListener();
      setupPeriodicSync();
    };

    const initialize = () => {
      console.debug("Initializing Giscus theme sync");
      loadGiscus();
      initializeEventListeners();
    };

    if (document.readyState === "loading") {
      window.addEventListener("load", initialize);
    } else {
      initialize();
    }
  })();
</script>
