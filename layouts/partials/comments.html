{{ $isDark := eq (.Site.Params.defaultAppearance | default "light") "dark" }} {{
$themeUrl := cond $isDark "https://leafevans.github.io/css/giscus-fire-dark.css"
"https://leafevans.github.io/css/giscus-fire-light.css" }}

<div id="giscus-container"></div>

<script>
  (function () {
    const THEME_KEY = "giscus-theme-preference";

    function getThemeUrl() {
      const isDark = document.documentElement.classList.contains("dark");
      return isDark
        ? "https://leafevans.github.io/css/giscus-fire-dark.css"
        : "https://leafevans.github.io/css/giscus-fire-light.css";
    }

    function saveThemePreference() {
      try {
        localStorage.setItem(
          THEME_KEY,
          document.documentElement.classList.contains("dark") ? "dark" : "light"
        );
      } catch (e) {}
    }

    function loadGiscus() {
      saveThemePreference();

      const container = document.getElementById("giscus-container");
      container.innerHTML = "";

      const script = document.createElement("script");
      script.src = "https://giscus.app/client.js";
      script.setAttribute("data-repo", "LeafEvans/leafevans.github.io");
      script.setAttribute("data-repo-id", "R_kgDOPSoBtU");
      script.setAttribute("data-category", "Comments");
      script.setAttribute("data-category-id", "DIC_kwDOPSoBtc4CluJp");
      script.setAttribute("data-mapping", "pathname");
      script.setAttribute("data-strict", "0");
      script.setAttribute("data-reactions-enabled", "1");
      script.setAttribute("data-emit-metadata", "0");
      script.setAttribute("data-input-position", "bottom");
      script.setAttribute("data-theme", getThemeUrl());
      script.setAttribute("data-lang", "zh-CN");
      script.setAttribute("crossorigin", "anonymous");
      script.async = true;

      container.appendChild(script);
    }

    const themeObserver = new MutationObserver(() => {
      saveThemePreference();

      const giscusFrame = document.querySelector("iframe.giscus-frame");
      if (giscusFrame) {
        try {
          giscusFrame.contentWindow.postMessage(
            { giscus: { setConfig: { theme: getThemeUrl() } } },
            "https://giscus.app"
          );
        } catch (e) {}
      }
    });

    themeObserver.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ["class"],
    });

    function setupMessageListener() {
      window.addEventListener("message", function (event) {
        if (event.origin !== "https://giscus.app") return;

        try {
          const data = event.data;

          if (
            data &&
            data.giscus &&
            (data.giscus.discussion ||
              data.giscus.error ||
              data.giscus.authenticated !== undefined)
          ) {
            setTimeout(() => {
              const giscusFrame = document.querySelector("iframe.giscus-frame");
              if (giscusFrame) {
                giscusFrame.contentWindow.postMessage(
                  { giscus: { setConfig: { theme: getThemeUrl() } } },
                  "https://giscus.app"
                );
              }
            }, 300);
          }
        } catch (e) {}
      });
    }

    function startPeriodicCheck() {
      setInterval(() => {
        const giscusFrame = document.querySelector("iframe.giscus-frame");
        if (giscusFrame) {
          const isDark = document.documentElement.classList.contains("dark");
          const stored = localStorage.getItem(THEME_KEY);

          if (
            (isDark && stored !== "dark") ||
            (!isDark && stored !== "light")
          ) {
            saveThemePreference();

            try {
              giscusFrame.contentWindow.postMessage(
                { giscus: { setConfig: { theme: getThemeUrl() } } },
                "https://giscus.app"
              );
            } catch (e) {}
          }
        }
      }, 2000);
    }

    function watchDomChanges() {
      const observer = new MutationObserver((mutations) => {
        for (const mutation of mutations) {
          for (const node of mutation.addedNodes) {
            if (
              node.nodeName === "IFRAME" &&
              node.classList.contains("giscus-frame")
            ) {
              node.addEventListener("load", () => {
                setTimeout(() => {
                  try {
                    node.contentWindow.postMessage(
                      { giscus: { setConfig: { theme: getThemeUrl() } } },
                      "https://giscus.app"
                    );
                  } catch (e) {}
                }, 200);
              });

              setTimeout(() => {
                try {
                  node.contentWindow.postMessage(
                    { giscus: { setConfig: { theme: getThemeUrl() } } },
                    "https://giscus.app"
                  );
                } catch (e) {}
              }, 100);
            }
          }
        }
      });

      observer.observe(document, {
        childList: true,
        subtree: true,
      });
    }

    window.addEventListener("load", function () {
      loadGiscus();

      setupMessageListener();
      watchDomChanges();
      startPeriodicCheck();

      document.addEventListener(
        "click",
        function (e) {
          if (
            e.target &&
            (e.target.innerText || "").match(/login|sign|退出|登录/i)
          ) {
            setTimeout(() => {
              const giscusFrame = document.querySelector("iframe.giscus-frame");
              if (giscusFrame) {
                try {
                  giscusFrame.contentWindow.postMessage(
                    { giscus: { setConfig: { theme: getThemeUrl() } } },
                    "https://giscus.app"
                  );
                } catch (e) {}
              }
            }, 1000);
          }
        },
        true
      );
    });
  })();
</script>
