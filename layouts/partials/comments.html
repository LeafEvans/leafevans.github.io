<div id="giscus-container"></div>

<script>
  (function () {
    "use strict";

    const CONFIG = {
      GISCUS_ORIGIN: "https://giscus.app",
      BASE_THEME_URL: "https://leafevans.github.io/css/giscus-base.css",
      THEME_URLS: {
        dark: "https://leafevans.github.io/css/giscus-fire-dark.css",
        light: "https://leafevans.github.io/css/giscus-fire-light.css",
      },
      GISCUS_ATTRS: {
        "data-repo": "LeafEvans/leafevans.github.io",
        "data-repo-id": "R_kgDOP5oBLw",
        "data-category": "Comments",
        "data-category-id": "DIC_kwDOP5oBL84CwFBN",
        "data-mapping": "pathname",
        "data-strict": "0",
        "data-reactions-enabled": "1",
        "data-emit-metadata": "0",
        "data-input-position": "bottom",
        "data-lang": "zh-CN",
        crossorigin: "anonymous",
      },
    };

    const getCurrentTheme = () => {
      const isDark = document.documentElement.classList.contains("dark");
      return {
        name: isDark ? "dark" : "light",
        url: CONFIG.THEME_URLS[isDark ? "dark" : "light"],
      };
    };

    const sendMessage = (message) => {
      const iframe = document.querySelector("iframe.giscus-frame");
      if (iframe && iframe.contentWindow) {
        iframe.contentWindow.postMessage(
          { giscus: message },
          CONFIG.GISCUS_ORIGIN
        );
      }
    };

    const updateGiscusTheme = () => {
      const theme = getCurrentTheme();
      sendMessage({ setConfig: { theme: theme.url } });
    };

    const injectBaseStyles = () => {
      const css = `@import url('${CONFIG.BASE_THEME_URL}');`;
      sendMessage({ setConfig: { theme: css } });
    };

    const loadGiscus = () => {
      const container = document.getElementById("giscus-container");
      if (!container) return;

      const theme = getCurrentTheme();
      const script = document.createElement("script");
      script.src = `${CONFIG.GISCUS_ORIGIN}/client.js`;
      script.async = true;

      Object.entries(CONFIG.GISCUS_ATTRS).forEach(([key, value]) => {
        script.setAttribute(key, value);
      });
      const initialTheme = `@import url('${CONFIG.BASE_THEME_URL}'); @import url('${theme.url}');`;
      script.setAttribute("data-theme", initialTheme);

      container.appendChild(script);
    };

    const initializeEventListeners = () => {
      new MutationObserver(updateGiscusTheme).observe(
        document.documentElement,
        {
          attributes: true,
          attributeFilter: ["class"],
        }
      );
    };

    loadGiscus();
    initializeEventListeners();
  })();
</script>
