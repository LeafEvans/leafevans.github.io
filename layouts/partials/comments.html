{{ $isDark := eq (.Site.Params.defaultAppearance | default "light") "dark" }} {{
$themeUrl := cond $isDark "https://leafevans.github.io/css/giscus-fire-dark.css"
"https://leafevans.github.io/css/giscus-fire-light.css" }}

<script
  src="https://giscus.app/client.js"
  data-repo="LeafEvans/leafevans.github.io"
  data-repo-id="R_kgDOPSoBtU"
  data-category="Comments"
  data-category-id="DIC_kwDOPSoBtc4CluJp"
  data-mapping="pathname"
  data-strict="0"
  data-reactions-enabled="1"
  data-emit-metadata="0"
  data-input-position="bottom"
  data-theme="{{ $themeUrl }}"
  data-lang="zh-CN"
  crossorigin="anonymous"
  async
></script>

<script>
  (function () {
    let isApplyingTheme = false;

    function getThemeUrl() {
      const isDark = document.documentElement.classList.contains("dark");
      return isDark
        ? "https://leafevans.github.io/css/giscus-fire-dark.css"
        : "https://leafevans.github.io/css/giscus-fire-light.css";
    }

    function setGiscusTheme() {
      const giscusFrame = document.querySelector("iframe.giscus-frame");
      if (giscusFrame && !isApplyingTheme) {
        isApplyingTheme = true;
        try {
          giscusFrame.contentWindow.postMessage(
            { giscus: { setConfig: { theme: getThemeUrl() } } },
            "https://giscus.app"
          );
          return true;
        } catch (error) {
          console.warn("Giscus theme update failed:", error);
          return false;
        } finally {
          setTimeout(() => {
            isApplyingTheme = false;
          }, 100);
        }
      }
      return false;
    }

    function retrySetTheme(maxRetries = 10, delay = 200) {
      let retries = 0;
      const intervalId = setInterval(() => {
        if (setGiscusTheme() || retries >= maxRetries) {
          clearInterval(intervalId);
        }
        retries++;
      }, delay);
    }

    const themeObserver = new MutationObserver(() => {
      setGiscusTheme();
    });
    themeObserver.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ["class"],
    });

    window.addEventListener("load", function () {
      retrySetTheme();

      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          mutation.addedNodes.forEach((node) => {
            if (
              node.nodeName === "IFRAME" &&
              node.classList.contains("giscus-frame") &&
              !node.dataset.themeObserved
            ) {
              node.dataset.themeObserved = "true";

              node.addEventListener("load", () => {
                retrySetTheme(8, 250);
              });

              setTimeout(() => retrySetTheme(5, 150), 100);
            }
          });
        });
      });

      observer.observe(document.body, {
        childList: true,
        subtree: true,
      });

      let messageCount = 0;
      window.addEventListener("message", (event) => {
        if (event.origin === "https://giscus.app" && messageCount < 3) {
          messageCount++;
          setTimeout(setGiscusTheme, 150);
        }
      });
    });
  })();
</script>
