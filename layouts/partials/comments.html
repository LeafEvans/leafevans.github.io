{{ $isDark := eq (.Site.Params.defaultAppearance | default "light") "dark" }} {{
$themeUrl := cond $isDark "https://leafevans.github.io/css/giscus-fire-dark.css"
"https://leafevans.github.io/css/giscus-fire-light.css" }}

<script
  src="https://giscus.app/client.js"
  data-repo="LeafEvans/leafevans.github.io"
  data-repo-id="R_kgDOPSoBtU"
  data-category="Comments"
  data-category-id="DIC_kwDOPSoBtc4CluJp"
  data-mapping="pathname"
  data-strict="0"
  data-reactions-enabled="1"
  data-emit-metadata="0"
  data-input-position="bottom"
  data-theme="{{ $themeUrl }}"
  data-lang="zh-CN"
  crossorigin="anonymous"
  async
></script>

<script>
  (function () {
    function getThemeUrl() {
      const isDark = document.documentElement.classList.contains("dark");
      return isDark
        ? "https://leafevans.github.io/css/giscus-fire-dark.css"
        : "https://leafevans.github.io/css/giscus-fire-light.css";
    }

    function setGiscusTheme() {
      const giscusFrame = document.querySelector("iframe.giscus-frame");
      if (giscusFrame) {
        try {
          giscusFrame.contentWindow.postMessage(
            { giscus: { setConfig: { theme: getThemeUrl() } } },
            "https://giscus.app"
          );
          return true;
        } catch (error) {
          return false;
        }
      }
      return false;
    }

    const themeObserver = new MutationObserver(setGiscusTheme);
    themeObserver.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ["class"],
    });

    window.addEventListener("load", function () {
      setTimeout(setGiscusTheme, 500);

      const giscusContainer = document.querySelector(".giscus");
      if (giscusContainer) {
        const iframeObserver = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            mutation.addedNodes.forEach((node) => {
              if (
                node.nodeName === "IFRAME" &&
                node.classList.contains("giscus-frame")
              ) {
                node.addEventListener("load", () => {
                  setTimeout(setGiscusTheme, 200);
                });
              }
            });
          });
        });

        iframeObserver.observe(giscusContainer, {
          childList: true,
          subtree: true,
        });
      }
    });
  })();
</script>
